#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
EXAMPLES_DIR="$SCRIPT_DIR/../src/langgraph_codegen/data/examples"

architectures=(
    "multi_agent_collaboration"
    "plan_and_execute"
    "rag"
    "react_agent"
    "simple"
    "supervisor"
)

# Clean up previous results
mkdir -p "$SCRIPT_DIR/actual_results"
rm -f "$SCRIPT_DIR/actual_results"/*

TMPDIR=$(mktemp -d)
trap "rm -rf $TMPDIR" EXIT

for arch in "${architectures[@]}"; do
    echo "Testing: $arch"

    # Find the example file (.lg, .graph, or .txt)
    if [ -f "$EXAMPLES_DIR/$arch.lg" ]; then
        input_file="$EXAMPLES_DIR/$arch.lg"
    elif [ -f "$EXAMPLES_DIR/$arch.graph" ]; then
        input_file="$EXAMPLES_DIR/$arch.graph"
    elif [ -f "$EXAMPLES_DIR/$arch.txt" ]; then
        input_file="$EXAMPLES_DIR/$arch.txt"
    else
        echo "Error: No example file found for $arch"
        exit 1
    fi

    # Test 1: Generate files (into output subdirectory)
    (cd "$TMPDIR" && lgcodegen "$input_file")

    # Test 2: Verify 3 files exist in the output subdirectory
    for suffix in state nodes graph; do
        if [ ! -f "$TMPDIR/${arch}/${arch}_${suffix}.py" ]; then
            echo "Error: Missing ${arch}/${arch}_${suffix}.py"
            exit 1
        fi
    done

    # Test 3: Verify files compile
    for suffix in state nodes graph; do
        python -c "compile(open('$TMPDIR/${arch}/${arch}_${suffix}.py').read(), '${arch}_${suffix}.py', 'exec')"
    done

    # Test 4: Capture stdout output and compare against expected
    lgcodegen "$input_file" --stdout > "$SCRIPT_DIR/actual_results/$arch.txt"

    if [ -f "$SCRIPT_DIR/expected_results/$arch.txt" ]; then
        diff -b "$SCRIPT_DIR/expected_results/$arch.txt" "$SCRIPT_DIR/actual_results/$arch.txt" || {
            echo "Error: Output mismatch for $arch"
            exit 1
        }
    else
        echo "  (no expected results file, skipping comparison)"
    fi

    # Clean up generated output directory
    rm -rf "$TMPDIR/${arch}"

    echo "  OK"
done

echo "All tests passed."
