
# Graph State: AgentState
from typing import Annotated, TypedDict

def add_str_to_list(a=None, b=""):
    return (a if a is not None else []) + ([b] if not isinstance(b, list) else b)

def add_int(a, b):
    if b == 0: return 0
    return b+1 if a==b else b

class AgentState(TypedDict):
    nodes_visited: Annotated[list[str], add_str_to_list]
    counter: Annotated[int, add_int]

def initialize_AgentState():
    return { 'nodes_visited': [], 'counter': 0 }


# Node Functions
def format_docs(state: AgentState, *, config:Optional[RunnableConfig] = None):
    print(f'NODE: format_docs')
    return { 'nodes_visited': 'format_docs', 'counter': state['counter'] + 1 }

def format_prompt(state: AgentState, *, config:Optional[RunnableConfig] = None):
    print(f'NODE: format_prompt')
    return { 'nodes_visited': 'format_prompt', 'counter': state['counter'] + 1 }

def generate(state: AgentState, *, config:Optional[RunnableConfig] = None):
    print(f'NODE: generate')
    return { 'nodes_visited': 'generate', 'counter': state['counter'] + 1 }

def get_docs(state: AgentState, *, config:Optional[RunnableConfig] = None):
    print(f'NODE: get_docs')
    return { 'nodes_visited': 'get_docs', 'counter': state['counter'] + 1 }


# Graph Builder: rag
from langgraph.graph import START, END, StateGraph
from langgraph.checkpoint.memory import MemorySaver
import sqlite3

checkpoint_saver = MemorySaver()
builder_rag = StateGraph(AgentState)
builder_rag.add_node('get_docs', get_docs)
builder_rag.add_node('format_docs', format_docs)
builder_rag.add_node('format_prompt', format_prompt)
builder_rag.add_node('generate', generate)
builder_rag.add_edge(START, 'get_docs')
builder_rag.add_edge('get_docs', 'format_docs')
builder_rag.add_edge('format_docs', 'format_prompt')
builder_rag.add_edge('format_prompt', 'generate')
builder_rag.add_edge('generate', END)

rag = builder_rag.compile(checkpointer=checkpoint_saver)

