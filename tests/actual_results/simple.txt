
# Graph State: State
from typing import Annotated, TypedDict

def add_str_to_list(a=None, b=""):
    return (a if a is not None else []) + ([b] if not isinstance(b, list) else b)

def add_int(a, b):
    if b == 0: return 0
    return b+1 if a==b else b

class State(TypedDict):
    nodes_visited: Annotated[list[str], add_str_to_list]
    counter: Annotated[int, add_int]

def initialize_State():
    return { 'nodes_visited': [], 'counter': 0 }


# Node Functions
def handle_error(state: State, *, config:Optional[RunnableConfig] = None):
    print(f'NODE: handle_error')
    return { 'nodes_visited': 'handle_error', 'counter': state['counter'] + 1 }

def process_input(state: State, *, config:Optional[RunnableConfig] = None):
    print(f'NODE: process_input')
    return { 'nodes_visited': 'process_input', 'counter': state['counter'] + 1 }

def store_result(state: State, *, config:Optional[RunnableConfig] = None):
    print(f'NODE: store_result')
    return { 'nodes_visited': 'store_result', 'counter': state['counter'] + 1 }

def transform_data(state: State, *, config:Optional[RunnableConfig] = None):
    print(f'NODE: transform_data')
    return { 'nodes_visited': 'transform_data', 'counter': state['counter'] + 1 }

def validate_data(state: State, *, config:Optional[RunnableConfig] = None):
    print(f'NODE: validate_data')
    return { 'nodes_visited': 'validate_data', 'counter': state['counter'] + 1 }


import random

def random_one_or_zero():
    return random.choice([False, True])

# Conditional Edge Functions
# Functions that determine which path to take in the graph
def is_valid(state: State) -> bool:
    result = random_one_or_zero()
    print(f'CONDITION: is_valid. Result: {result}')
    return result


def is_invalid(state: State) -> bool:
    result = random_one_or_zero()
    print(f'CONDITION: is_invalid. Result: {result}')
    return result


# Graph Builder: simple
from langgraph.graph import START, END, StateGraph
from langgraph.checkpoint.memory import MemorySaver
import sqlite3

checkpoint_saver = MemorySaver()
builder_simple = StateGraph(State)
builder_simple.add_node('process_input', process_input)
builder_simple.add_node('validate_data', validate_data)
builder_simple.add_node('transform_data', transform_data)
builder_simple.add_node('store_result', store_result)
builder_simple.add_node('handle_error', handle_error)
builder_simple.add_edge(START, 'process_input')
builder_simple.add_edge('process_input', 'validate_data')
def after_validate_data(state: State):
    if is_valid(state):
        return 'transform_data'
    elif is_invalid(state):
        return 'handle_error'
    return 'END'

validate_data_conditional_edges = { 'transform_data': 'transform_data', 'handle_error': 'handle_error', 'END': END }
builder_simple.add_conditional_edges('validate_data', after_validate_data, validate_data_conditional_edges)

builder_simple.add_edge('transform_data', 'store_result')
builder_simple.add_edge('store_result', END)
builder_simple.add_edge('handle_error', END)

simple = builder_simple.compile(checkpointer=checkpoint_saver)

