#!/usr/bin/env bash
set -euo pipefail

EXAMPLES=(
  bea_agent
  bea_evaluator_optimizer
  bea_orchestrator_worker
  bea_parallelization
  bea_prompt_chaining
  define_state
  guard
  lgcodegen
  multi_agent_collaboration
  plan_and_execute
  rag
  react_agent
  simple
  supervisor
)

ROOT="$(cd "$(dirname "$0")" && pwd)"
RUN_MD="$ROOT/run.md"

# Clean previous output dirs
for name in "${EXAMPLES[@]}"; do
  rm -rf "$ROOT/$name"
done

# Generate and run each example
FAILED=()

for name in "${EXAMPLES[@]}"; do
  echo "=== $name ==="

  # Generate
  (cd "$ROOT" && lgcodegen "$name")

  # Run
  DIR="$ROOT/$name"
  LOG="$DIR/${name}_run.log"

  if [[ -f "$DIR/main.py" ]]; then
    (cd "$DIR" && python main.py > "$LOG" 2>&1) && STATUS=0 || STATUS=$?
    if [[ $STATUS -ne 0 ]]; then
      FAILED+=("$name")
      echo "  FAILED (exit $STATUS)"
    else
      echo "  OK"
    fi
  else
    echo "  SKIPPED (no main.py)"
    echo "(no main.py generated)" > "$LOG"
  fi

  echo
done

# Build run.md
{
  echo "# Example Runs"
  echo ""
  echo "Generated by \`./testit\` on $(date '+%Y-%m-%d %H:%M')."
  echo ""

  for name in "${EXAMPLES[@]}"; do
    echo "## $name"
    echo ""
    LGRAPH="$ROOT/$name/$name.lgraph"
    if [[ -f "$LGRAPH" ]]; then
      echo '```'
      cat "$LGRAPH"
      echo '```'
      echo ""
    fi
    if [[ -f "$ROOT/$name/$name.png" ]]; then
      echo "![$name]($name/$name.png)"
    else
      echo "*(no graph image)*"
    fi
    echo ""
    echo "**Run output:**"
    echo ""
    echo '```'
    cat "$ROOT/$name/${name}_run.log"
    echo '```'
    echo ""
  done
} > "$RUN_MD"

echo "Wrote $RUN_MD"

# Summary
if [[ ${#FAILED[@]} -gt 0 ]]; then
  echo ""
  echo "FAILURES: ${FAILED[*]}"
  exit 1
else
  echo ""
  echo "All ${#EXAMPLES[@]} examples passed."
fi
